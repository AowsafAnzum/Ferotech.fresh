@model IEnumerable<FeroTech.Infrastructure.Application.DTOs.NotificationDto>

@{
    ViewData["Title"] = "Notifications";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

<h2 class="text-center mb-4">Notifications</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a asp-action="Create" class="btn btn-success">+ Add Notification</a>
    <div>
        <a asp-controller="Notification" asp-action="Index" class="btn btn-outline-secondary">
            All Notifications
        </a>
        <span class="ms-3">Unread: <span id="notifCountBadge" class="badge bg-danger"></span></span>
    </div>
</div>

<table class="table table-bordered table-striped align-middle">
    <thead class="table-dark">
        <tr>
            <th style="width:18%;">Title</th>
            <th>Message</th>
            <th style="width:10%;">Category</th>
            <th style="width:9%;">Is Read</th>
            <th style="width:17%;">Created At</th>
            <th style="width:18%;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            foreach (var n in Model)
            {
                var rowClass = n.IsRead ? "" : "table-secondary"; // unread highlight
                                                                  <tr id="notif-row-@n.NotificationId" class="@rowClass">
                                                                      <td>@n.Title</td>
                                                                      <td style="text-align:left;">@n.Message</td>
                                                                      <td>@n.Category</td>
                                                                      <td>
                        @if (n.IsRead)
                        {
                            <span class="badge bg-success">Read</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Unread</span>
                        }
                    </td>
                    <td>@n.CreatedAt.ToString("dd/MM/yyyy hh:mm tt")</td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            @* Toggle Read/Unread form (AJAX-friendly) *@
                            <form class="mark-read-form" method="post" asp-action="MarkAsRead" asp-controller="Notification">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@n.NotificationId" />
                                @if (!n.IsRead)
                                {
                                    <button type="submit" class="btn btn-sm btn-primary btn-mark-read" data-id="@n.NotificationId">Mark Read</button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-mark-unread" data-id="@n.NotificationId">Mark Unread</button>
                                }
                            </form>

                            @* Delete form *@
                            <form class="delete-form" method="post" asp-action="Delete" asp-controller="Notification" onsubmit="return confirm('Delete this notification?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@n.NotificationId" />
                                <button type="submit" class="btn btn-sm btn-danger btn-delete" data-id="@n.NotificationId">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="6" class="text-muted text-center">No notifications found.</td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        (function () {
            // read badge initial count from server via AJAX
            async function loadUnreadCount() {
                try {
                    const res = await fetch('@Url.Action("UnreadCount", "Notification")');
                    if (!res.ok) return;
                    const count = await res.json();
                    document.getElementById('notifCountBadge').textContent = count > 0 ? count : '';
                } catch (e) {
                    console.warn('Could not load unread count', e);
                }
            }

            // Use form submission with AJAX for Mark Read/Unread and Delete
            async function postForm(url, formData) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const headers = { 'X-Requested-With': 'XMLHttpRequest' };
                // use application/x-www-form-urlencoded body
                const body = new URLSearchParams(formData);
                body.append('__RequestVerificationToken', token);

                const resp = await fetch(url, {
                    method: 'POST',
                    headers,
                    body
                });
                return resp;
            }

            // Mark Read buttons
            document.querySelectorAll('.btn-mark-read').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    const url = '@Url.Action("MarkAsRead", "Notification")';
                    const res = await postForm(url, [['id', id]]);
                    if (res.ok) {
                        // update UI: change badge and row style
                        document.querySelector(`#notif-row-${id} .badge`).className = 'badge bg-success';
                        document.querySelector(`#notif-row-${id}`).classList.remove('table-secondary');
                        // replace button to Mark Unread
                        this.closest('form').querySelector('.btn-mark-read').outerHTML =
                            `<button type="button" class="btn btn-sm btn-outline-primary btn-mark-unread" data-id="${id}">Mark Unread</button>`;
                        attachMarkUnreadHandler(document.querySelector(`.btn-mark-unread[data-id="${id}"]`));
                        await loadUnreadCount();
                    }
                });
            });

            // Mark Unread handler factory
            function attachMarkUnreadHandler(btn) {
                if (!btn) return;
                btn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    const url = '@Url.Action("MarkAsUnread", "Notification")';
                    const res = await postForm(url, [['id', id]]);
                    if (res.ok) {
                        // update UI
                        const badgeEl = document.querySelector(`#notif-row-${id} td .badge`);
                        if (badgeEl) badgeEl.className = 'badge bg-warning text-dark';
                        document.querySelector(`#notif-row-${id}`).classList.add('table-secondary');
                        // swap button back to Mark Read
                        this.outerHTML =
                            `<button type="submit" class="btn btn-sm btn-primary btn-mark-read" data-id="${id}">Mark Read</button>`;
                        // attach handler to new Mark Read button
                        document.querySelector(`.btn-mark-read[data-id="${id}"]`).addEventListener('click', async function (e) {
                            e.preventDefault();
                            const id2 = this.dataset.id;
                            const url2 = '@Url.Action("MarkAsRead", "Notification")';
                            const res2 = await postForm(url2, [['id', id2]]);
                            if (res2.ok) {
                                document.querySelector(`#notif-row-${id2} .badge`).className = 'badge bg-success';
                                document.querySelector(`#notif-row-${id2}`).classList.remove('table-secondary');
                                await loadUnreadCount();
                            }
                        });
                        await loadUnreadCount();
                    }
                });
            }

            // attach all existing Mark Unread buttons (if any)
            document.querySelectorAll('.btn-mark-unread').forEach(btn => attachMarkUnreadHandler(btn));

            // Delete buttons (AJAX)
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    // form onsubmit handles confirm
                    // we intercept after confirmation via default form submit fallback
                    // But to perform AJAX delete, prevent default and call endpoint
                    e.preventDefault();
                    if (!confirm('Delete this notification?')) return;
                    const id = this.dataset.id;
                    const url = '@Url.Action("Delete", "Notification")';
                    const res = await postForm(url, [['id', id]]);
                    if (res.ok) {
                        // remove row
                        const row = document.getElementById(`notif-row-${id}`);
                        if (row) row.remove();
                        await loadUnreadCount();
                    } else {
                        alert('Delete failed');
                    }
                });
            });

            // initial load of unread count
            loadUnreadCount();
        })();
    </script>
}
